<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Buckeye Hunter Hub ‚Äî Mobile Hunting Map</title>
  
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- SunCalc for sunrise/sunset -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root{
      --bg:#0b1a0f;        /* deep forest */
      --panel:#101f14;     /* card */
      --muted:#1a2b1f;
      --accent:#6dbc5d;    /* green */
      --text:#e7f1e8;
      --subtle:#a3b7a6;
      --danger:#f87171;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Roboto,Arial,sans-serif}
    #map{position:fixed;inset:0}
    #map.placing{cursor: crosshair}

    /* Marker Menu (FAB + popup) */
    .fab-main{position:fixed;right:16px;bottom:120px;width:56px;height:56px;border-radius:50%;border:none;background:var(--accent);color:#0b1a0f;font-size:32px;display:flex;align-items:center;justify-content:center;z-index:1100;box-shadow:var(--shadow)}
    .marker-menu{position:fixed;right:16px;bottom:186px;background:linear-gradient(180deg,rgba(16,31,20,.98),rgba(16,31,20,.94));border:1px solid #203325;border-radius:16px;box-shadow:var(--shadow);padding:8px;display:none;flex-direction:column;gap:8px;z-index:1100;backdrop-filter:blur(6px)}
    .marker-menu button{padding:10px 12px;border:1px solid #25432b;border-radius:12px;background:#132218;color:var(--text);text-align:left}
    .marker-menu.show{display:flex}

    /* Bottom toolbar */
    .toolbar{position:fixed;right:12px;bottom:calc(56px + 12px + var(--safe-bottom));z-index:1050;background:linear-gradient(180deg,rgba(16,31,20,.98),rgba(16,31,20,.94));border:1px solid #203325;border-radius:14px;padding:8px 10px;box-shadow:var(--shadow);display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar button,label.button{padding:8px 12px;border:1px solid #25432b;border-radius:10px;background:#14271a;color:var(--text);cursor:pointer}
    .toolbar input[type="file"]{display:none}

    /* Info panel (smaller + draggable) */
    .panel{position:fixed;left:12px;top:80px;z-index:1000;background:var(--panel);border:1px solid #203325;border-radius:12px;box-shadow:var(--shadow);padding:8px 10px;min-width:180px;max-width:240px}
    .panel h3{margin:0 0 6px;font-size:14px;display:flex;align-items:center;gap:8px;cursor:move}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 0;border-bottom:1px solid #1d3323}
    .row:last-child{border-bottom:0}
    .tag{font-size:11px;color:var(--subtle)}

    /* Wind badge */
    .overlay-badge{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(56px + 140px);z-index:1000;background:#132218;border:1px solid #24412d;border-radius:12px;padding:6px 8px;box-shadow:var(--shadow);font-size:12px}

    /* Bottom main menu */
    .main-menu{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:flex;gap:8px;justify-content:space-around;align-items:center;padding:10px 12px calc(10px + var(--safe-bottom));background:linear-gradient(180deg,rgba(11,26,15,.1),rgba(11,26,15,.85));backdrop-filter:blur(8px);border-top:1px solid #203325}
    .main-menu button{flex:1;max-width:180px;padding:10px;border:1px solid #25432b;border-radius:12px;background:#14271a;color:var(--text);font-size:14px;cursor:pointer}

    @media (max-width:640px){
      .toolbar{left:8px;right:8px}
      .panel{left:8px;top:76px}
      .main-menu{gap:6px}
      .main-menu button{font-size:13px;padding:8px}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <!-- FAB + Menu for markers -->
    <button id="fabMain" class="fab-main" title="Add marker">Ôºã</button>
    <div id="markerMenu" class="marker-menu">
      <button data-type="stand">üéØ Tree Stand</button>
      <button data-type="feeder">üçΩÔ∏è Feeder</button>
      <button data-type="camera">üì∑ Trail Camera</button>
      <button data-type="scrape">ü¶å Scrape</button>
      <button data-type="rub">ü™µ Rub</button>
      <button data-type="water">üíß Water Source</button>
    </div>

    <!-- Bottom toolbar: export/import, clear, delete-mode toggle -->
    <div class="toolbar" id="mainToolbar">
      <button id="btnExport" title="Export drawings & markers">Export</button>
      <label class="button" for="fileImport" title="Import JSON/GeoJSON">Import</label>
      <input type="file" id="fileImport" accept=".json,.geojson,application/json,application/geo+json" />
      <button id="btnClear" title="Clear all">Clear</button>
      <button id="btnDeleteMode" title="Toggle delete mode">üóëÔ∏è Delete: Off</button>
    </div>

    <!-- Field Info panel (hidden by default; draggable) -->
    <section class="panel" id="infoPanel" style="display:none;">
      <h3 id="infoHandle">üìã Field Info</h3>
      <div class="row"><span>Sunrise</span><strong id="pSunrise" class="tag">--:--</strong></div>
      <div class="row"><span>Sunset</span><strong id="pSunset" class="tag">--:--</strong></div>
      <div class="row"><span>Day Length</span><strong id="pDay" class="tag">--h --m</strong></div>
      <div class="row"><span>Total Distance</span><strong id="pDist" class="tag">0 m</strong></div>
      <div class="row"><span>Area</span><strong id="pArea" class="tag">0 m¬≤</strong></div>
      <p class="tag">Tap Ôºã to select a marker type, then tap the map to place. Toggle üóëÔ∏è to remove with a tap.</p>
    </section>

    <!-- Wind badge -->
    <div class="overlay-badge" id="windBadge">üí® Wind: <span id="windDir">N</span></div>

    <!-- Bottom main menu -->
    <nav class="main-menu" id="mainMenu">
      <button id="toggleFieldInfo">Field Info</button>
      <button id="toggleBasemap">Basemap</button>
      <button id="menuLocate">Locate Me</button>
    </nav>
  </div>

  <script>
    /*******************
     * MAP & BASELAYERS *
     *******************/
    const map = L.map('map').setView([40.4173, -82.9071], 7);
    const basic = L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=VLOZCnjQYBtgpZ3BXBK3', { attribution: '&copy; MapTiler & OpenStreetMap contributors' }).addTo(map);
    const satellite = L.tileLayer('https://api.maptiler.com/tiles/satellite-v2/{z}/{x}/{y}.jpg?key=VLOZCnjQYBtgpZ3BXBK3', { attribution: '&copy; MapTiler' });
    const topo = L.tileLayer('https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=VLOZCnjQYBtgpZ3BXBK3', { attribution: '&copy; MapTiler & OpenStreetMap contributors' });
    const basemaps = [basic, satellite, topo];
    let basemapIndex = 0;
    function cycleBasemap(){ basemapIndex = (basemapIndex + 1) % basemaps.length; basemaps.forEach((l,i)=>{ if(i===basemapIndex) l.addTo(map); else map.removeLayer(l); }); }

    /*******************
     * DRAWING LAYERS  *
     *******************/
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({ position:'topleft', edit:{ featureGroup: drawnItems }, draw:{ circle:false } });
    map.addControl(drawControl);

    const STORAGE_DRAW = 'bhh_drawings_v2';
    function saveDraw(){ localStorage.setItem(STORAGE_DRAW, JSON.stringify(drawnItems.toGeoJSON())); updateMeasurements(); }
    function restoreDraw(){ const raw = localStorage.getItem(STORAGE_DRAW); if(raw){ L.geoJSON(JSON.parse(raw), { onEachFeature:(_,layer)=> drawnItems.addLayer(layer) }); updateMeasurements(); } }
    restoreDraw();

    map.on(L.Draw.Event.CREATED, e=>{ drawnItems.addLayer(e.layer); saveDraw(); });
    map.on(L.Draw.Event.EDITED, saveDraw);
    map.on(L.Draw.Event.DELETED, saveDraw);

    /*******************
     * MARKERS LAYER    *
     *******************/
    const markersLayer = L.featureGroup().addTo(map);
    const STORAGE_MARK = 'bhh_markers_v2';
    const IS_MOBILE = matchMedia('(max-width:640px)').matches;
    const ICON_SZ = IS_MOBILE ? 28 : 32;
    const FONT_SZ = IS_MOBILE ? 16 : 18;

    function makeIcon(bg,emoji){
      return L.divIcon({
        className:'',
        html:`<div style="background:${bg};border:2px solid #333;border-radius:50%;width:${ICON_SZ}px;height:${ICON_SZ}px;display:flex;align-items:center;justify-content:center;font-size:${FONT_SZ}px;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.4);">${emoji}</div>`,
        iconSize:[ICON_SZ,ICON_SZ], iconAnchor:[ICON_SZ/2, ICON_SZ], popupAnchor:[0, -ICON_SZ*0.9]
      });
    }

    const markerTypes = { stand:{label:'Tree Stand', icon:makeIcon('#2563eb','üéØ')}, feeder:{label:'Feeder', icon:makeIcon('#16a34a','üçΩÔ∏è')}, camera:{label:'Trail Camera', icon:makeIcon('#111827','üì∑')}, scrape:{label:'Scrape', icon:makeIcon('#6d28d9','ü¶å')}, rub:{label:'Rub', icon:makeIcon('#b45309','ü™µ')}, water:{label:'Water Source', icon:makeIcon('#0891b2','üíß')} };

    let activeType=null; let deleteMode=false;
    function setActiveType(type){ activeType=type; document.getElementById('map').classList.toggle('placing', !!type); }

    function addMarker(latlng, type){
      const cfg = markerTypes[type] || {label:'Marker', icon:makeIcon('#555','üìç')};
      const m = L.marker(latlng, { icon: cfg.icon, draggable:true, type });
      m.bindPopup(`<b>${cfg.label}</b><br><button class="del">Delete</button>`);
      m.on('dragend', saveMarkers);
      m.on('click', () => { if(deleteMode){ markersLayer.removeLayer(m); saveMarkers(); } });
      m.on('popupopen', (e)=>{ const btn = e.popup.getElement().querySelector('button.del'); if(btn) btn.addEventListener('click', ()=> { markersLayer.removeLayer(m); saveMarkers(); }); });
      markersLayer.addLayer(m); saveMarkers();
    }

    function serializeMarkers(){ const list=[]; markersLayer.eachLayer(m=>{ const {lat,lng}=m.getLatLng(); list.push({type:m.options.type||'marker', lat, lng}); }); return list; }
    function deserializeMarkers(list){ markersLayer.clearLayers(); (list||[]).forEach(m=> addMarker([m.lat,m.lng], m.type)); }
    function saveMarkers(){ localStorage.setItem(STORAGE_MARK, JSON.stringify(serializeMarkers())); }
    ;(function restoreMarkers(){ try{ const raw=localStorage.getItem(STORAGE_MARK); if(raw) deserializeMarkers(JSON.parse(raw)); }catch(e){} })();

    map.on('click', e=>{ if(!activeType) return; addMarker(e.latlng, activeType); setActiveType(null); });

    /*******************
     * OHIO PUBLIC HUNTING (ODNR) *
     *******************/
    const ohioPublic = L.geoJSON(null, { style:{ color:'#8b5cf6', weight:2, fillOpacity:0.15 } });
    fetch('https://gis2.ohiodnr.gov/ArcGIS/rest/services/OIT_Services/DNR_Fed_Lands_Nav_Base/MapServer/2/query?where=1%3D1&outFields=*&outSR=4326&f=geojson')
      .then(r=>r.json())
      .then(j=> ohioPublic.addData(j))
      .catch(err=> console.warn('ODNR layer fetch failed', err));

    /*******************
     * LAYERS CONTROL   *
     *******************/
    const layersCtl = L.control.layers(
      { 'Basic':basic, 'Satellite':satellite, 'Topographic':topo },
      { 'Ohio Public Hunting (ODNR)': ohioPublic, 'My Drawings':drawnItems, 'Hunt Markers':markersLayer },
      { position:'bottomleft' }
    ).addTo(map);

    /*******************
     * TOOLBAR ACTIONS  *
     *******************/
    const btnExport = document.getElementById('btnExport');
    const btnClear  = document.getElementById('btnClear');
    const btnDelete = document.getElementById('btnDeleteMode');
    const fileInput = document.getElementById('fileImport');

    btnExport.onclick = () => {
      const data = { drawings: drawnItems.toGeoJSON(), markers: serializeMarkers() };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='buckeyehunterhub-export.json'; a.click(); URL.revokeObjectURL(url);
    };
    btnClear.onclick = () => { drawnItems.clearLayers(); saveDraw(); markersLayer.clearLayers(); saveMarkers(); updateMeasurements(); };
    btnDelete.onclick = () => { deleteMode = !deleteMode; btnDelete.textContent = `üóëÔ∏è Delete: ${deleteMode? 'On':'Off'}`; };
    fileInput.onchange = (ev) => {
      const f = ev.target.files[0]; if(!f) return; const r=new FileReader();
      r.onload = () => { try{ const obj = JSON.parse(r.result);
        if(obj.type==='FeatureCollection' || obj.type==='Feature'){ L.geoJSON(obj, {onEachFeature:(_,l)=>drawnItems.addLayer(l)}); saveDraw(); }
        else { if(obj.drawings) L.geoJSON(obj.drawings, {onEachFeature:(_,l)=>drawnItems.addLayer(l)}); if(obj.markers) deserializeMarkers(obj.markers); saveDraw(); saveMarkers(); }
      } catch{ alert('Invalid JSON/GeoJSON file'); } finally { ev.target.value=''; } };
      r.readAsText(f);
    };

    /*******************
     * SUN / WIND INFO  *
     *******************/
    function updateSun(){
      const c = map.getCenter();
      const now = new Date();
      const t = SunCalc.getTimes(now, c.lat, c.lng);
      const fmt = d => d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
      document.getElementById('pSunrise').textContent = fmt(t.sunrise);
      document.getElementById('pSunset').textContent  = fmt(t.sunset);
      const mins = Math.max(0, (t.sunset - t.sunrise)/60000|0);
      document.getElementById('pDay').textContent = `${Math.floor(mins/60)}h ${mins%60}m`;
    }
    function updateWindKeys(){
      const dirs=['N','NE','E','SE','S','SW','W','NW'];
      window.addEventListener('keydown', (e)=>{
        const el = document.getElementById('windDir');
        let i = dirs.indexOf(el.textContent);
        if(e.key==='ArrowRight'){ i=(i+1+8)%8; el.textContent=dirs[i]; }
        if(e.key==='ArrowLeft'){  i=(i-1+8)%8; el.textContent=dirs[i]; }
      });
    }
    updateSun(); map.on('moveend', updateSun); updateWindKeys();

    /*******************
     * MEASUREMENTS     *
     *******************/
    function updateMeasurements(){
      // Distance: sum of polylines
      let dist=0; drawnItems.eachLayer(l=>{
        if(l instanceof L.Polyline && !(l instanceof L.Polygon)){
          const latlngs = l.getLatLngs();
          for(let i=1;i<latlngs.length;i++){ dist += map.distance(latlngs[i-1], latlngs[i]); }
        }
      });
      document.getElementById('pDist').textContent = dist>1000 ? (dist/1000).toFixed(2)+' km' : Math.round(dist)+' m';

      // Area: polygons (approx)
      let area=0; drawnItems.eachLayer(l=>{ if(l instanceof L.Polygon){ const rings=l.getLatLngs()[0]||[]; for(let i=0;i<rings.length;i++){ const a=rings[i], b=rings[(i+1)%rings.length]; area += (a.lng*b.lat - b.lng*a.lat); } area=Math.abs(area/2)*12365; } });
      const areaEl=document.getElementById('pArea');
      if(area>1e6) areaEl.textContent=(area/1e6).toFixed(2)+' km¬≤'; else if(area>1e4) areaEl.textContent=(area/1e4).toFixed(1)+' ha'; else areaEl.textContent=Math.round(area)+' m¬≤';
    }
    map.on(L.Draw.Event.CREATED, updateMeasurements);
    map.on(L.Draw.Event.EDITED, updateMeasurements);
    map.on(L.Draw.Event.DELETED, updateMeasurements);

    /*******************
     * UI: FAB & MENU   *
     *******************/
    const fab = document.getElementById('fabMain');
    const menu = document.getElementById('markerMenu');
    fab.onclick = ()=> menu.classList.toggle('show');
    menu.querySelectorAll('button[data-type]').forEach(btn=> btn.addEventListener('click', ()=>{ setActiveType(btn.dataset.type); menu.classList.remove('show'); }));

    /*******************
     * BOTTOM MAIN MENU *
     *******************/
    const btnFieldInfo = document.getElementById('toggleFieldInfo');
    const infoPanel = document.getElementById('infoPanel');
    const btnBasemap = document.getElementById('toggleBasemap');
    const btnLocate  = document.getElementById('menuLocate');

    const STORAGE_INFO_POS = 'ui_info_pos';
    const STORAGE_INFO_VIS = 'ui_info_visible';

    function setInfoVisible(v){ infoPanel.style.display = v? 'block':'none'; localStorage.setItem(STORAGE_INFO_VIS, v? '1':'0'); if(v){ updateSun(); updateMeasurements(); } }
    function getInfoVisible(){ return localStorage.getItem(STORAGE_INFO_VIS) === '1'; }

    btnFieldInfo.onclick = ()=> setInfoVisible(infoPanel.style.display==='none' || infoPanel.style.display==='');
    btnBasemap.onclick   = cycleBasemap;
    btnLocate.onclick    = ()=>{ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } navigator.geolocation.getCurrentPosition(pos=>{ const latlng=[pos.coords.latitude, pos.coords.longitude]; map.setView(latlng, 15); }, err=> alert('Location error: '+err.message), { enableHighAccuracy:true, timeout:8000 }); };

    setInfoVisible(getInfoVisible());

    /*******************
     * DRAGGABLE PANEL  *
     *******************/
    function makeDraggable(el, handle, storageKey){
      let sx=0, sy=0, sl=0, st=0, dragging=false;
      const start=(x,y)=>{ dragging=true; sx=x; sy=y; const r=el.getBoundingClientRect(); sl=r.left; st=r.top; document.addEventListener('mousemove',move); document.addEventListener('mouseup',up); document.addEventListener('touchmove',tmove,{passive:false}); document.addEventListener('touchend',up); };
      const down=(e)=>{ const p=point(e); start(p.x,p.y); e.preventDefault(); };
      const tdown=(e)=>{ const p=point(e); start(p.x,p.y); };
      const move=(e)=>{ if(!dragging) return; const p=point(e); apply(sl+p.x-sx, st+p.y-sy); e.preventDefault(); };
      const tmove=(e)=>{ if(!dragging) return; const p=point(e); apply(sl+p.x-sx, st+p.y-sy); e.preventDefault(); };
      const up=()=>{ dragging=false; document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); document.removeEventListener('touchmove',tmove); document.removeEventListener('touchend',up); savePos(); };
      function point(e){ if(e.touches && e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY}; return {x:e.clientX,y:e.clientY}; }
      function apply(l,t){ const vw=innerWidth, vh=innerHeight; const w=el.offsetWidth, h=el.offsetHeight; l=Math.max(4,Math.min(vw-w-4,l)); t=Math.max(60,Math.min(vh-h-4,t)); el.style.left=l+'px'; el.style.top=t+'px'; }
      function savePos(){ const r=el.getBoundingClientRect(); localStorage.setItem(storageKey, JSON.stringify({left:r.left, top:r.top})); }
      try{ const s=JSON.parse(localStorage.getItem(storageKey)||'null'); if(s){ el.style.left=s.left+'px'; el.style.top=s.top+'px'; } }catch{}
      handle.addEventListener('mousedown',down); handle.addEventListener('touchstart',tdown,{passive:false});
    }

    makeDraggable(infoPanel, document.getElementById('infoHandle'), STORAGE_INFO_POS);
  </script>
</body>
</html>
