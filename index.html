<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Buckeye Hunter Hub ‚Äî Mobile Hunting Map</title>
  
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- SunCalc for sunrise/sunset -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root{
      --bg:#0b1a0f;        /* deep forest */
      --panel:#101f14;     /* card */
      --muted:#1a2b1f;
      --accent:#6dbc5d;    /* green */
      --text:#e7f1e8;
      --subtle:#a3b7a6;
      --danger:#f87171;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Roboto,Arial,sans-serif}
    #map{position:fixed;inset:0}
    #map.placing{cursor: crosshair}

    /* Marker Menu (FAB + popup) */
    .fab-main{position:fixed;right:16px;bottom:120px;width:56px;height:56px;border-radius:50%;border:none;background:var(--accent);color:#0b1a0f;font-size:32px;display:flex;align-items:center;justify-content:center;z-index:1100;box-shadow:var(--shadow)}
    .marker-menu{position:fixed;right:16px;bottom:186px;background:linear-gradient(180deg,rgba(16,31,20,.98),rgba(16,31,20,.94));border:1px solid #203325;border-radius:16px;box-shadow:var(--shadow);padding:8px;display:none;flex-direction:column;gap:8px;z-index:1100;backdrop-filter:blur(6px)}
    .marker-menu button{padding:10px 12px;border:1px solid #25432b;border-radius:12px;background:#132218;color:var(--text);text-align:left}
    .marker-menu.show{display:flex}

    /* Bottom toolbar */
    .toolbar{position:fixed;right:12px;bottom:calc(56px + 12px + var(--safe-bottom));z-index:1050;background:linear-gradient(180deg,rgba(16,31,20,.98),rgba(16,31,20,.94));border:1px solid #203325;border-radius:14px;padding:8px 10px;box-shadow:var(--shadow);display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar button,label.button{padding:8px 12px;border:1px solid #25432b;border-radius:10px;background:#14271a;color:var(--text);cursor:pointer}
    .toolbar input[type="file"]{display:none}

    /* Info panel (smaller + draggable) */
    .panel{position:fixed;left:12px;top:80px;z-index:1000;background:var(--panel);border:1px solid #203325;border-radius:12px;box-shadow:var(--shadow);padding:8px 10px;min-width:180px;max-width:240px}
    .panel h3{margin:0 0 6px;font-size:14px;display:flex;align-items:center;gap:8px;cursor:move}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 0;border-bottom:1px solid #1d3323}
    .row:last-child{border-bottom:0}
    .tag{font-size:11px;color:var(--subtle)}

    /* Bottom main menu */
    .main-menu{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:flex;gap:8px;justify-content:space-around;align-items:center;padding:10px 12px calc(10px + var(--safe-bottom));background:linear-gradient(180deg,rgba(11,26,15,.1),rgba(11,26,15,.85));backdrop-filter:blur(8px);border-top:1px solid #203325}
    .main-menu button{flex:1;max-width:140px;padding:10px;border:1px solid #25432b;border-radius:12px;background:#14271a;color:var(--text);font-size:14px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .wind-btn{display:flex;align-items:center;gap:8px}
    .wind-arrow{width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:12px solid #e7f1e8;display:inline-block;transform:rotate(0deg)}

    /* Sheets (backdrop + panel) */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1199;display:none}
    .backdrop.show{display:block}
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:1200;background:var(--panel);border-top:1px solid #203325;border-radius:16px 16px 0 0;box-shadow:var(--shadow);transform:translateY(110%);transition:transform .25s ease}
    .sheet.show{transform:translateY(0)}
    .sheet .grab{width:36px;height:4px;border-radius:999px;background:#2b4231;margin:8px auto}
    .sheet .option{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid #1d3323}
    .sheet h4{margin:6px 16px 8px;font-size:14px;color:var(--subtle)}
    .sheet .content{padding:4px 16px 14px}
    .sheet .row{border:0}
    .sheet input[type="text"], .sheet input[type="number"], .sheet input[type="search"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #25432b;background:#14271a;color:var(--text)}
    .btn{padding:8px 12px;border:1px solid #25432b;border-radius:10px;background:#14271a;color:var(--text);cursor:pointer}
    .btn.danger{border-color:#5a2222;background:#331616}

    /* Waypoints list */
    .wp-list{max-height:38vh;overflow:auto;margin-top:6px}
    .wp-item{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #1d3323}
    .wp-emoji{font-size:18px}
    .wp-name{min-width:0}
    .wp-actions button{margin-left:8px}

    @media (max-width:640px){
      .toolbar{left:8px;right:8px}
      .panel{left:8px;top:76px}
      .main-menu{gap:6px}
      .main-menu button{font-size:13px;padding:8px;max-width:120px}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <!-- FAB + Menu for markers -->
    <button id="fabMain" class="fab-main" title="Add marker">Ôºã</button>
    <div id="markerMenu" class="marker-menu">
      <button data-type="stand">üéØ Tree Stand</button>
      <button data-type="feeder">üçΩÔ∏è Feeder</button>
      <button data-type="camera">üì∑ Trail Camera</button>
      <button data-type="scrape">ü¶å Scrape</button>
      <button data-type="rub">ü™µ Rub</button>
      <button data-type="water">üíß Water Source</button>
    </div>

    <!-- Bottom toolbar: export/import, clear, delete-mode toggle -->
    <div class="toolbar" id="mainToolbar">
      <button id="btnExport" title="Export drawings & markers">Export</button>
      <label class="button" for="fileImport" title="Import JSON/GeoJSON">Import</label>
      <input type="file" id="fileImport" accept=".json,.geojson,application/json,application/geo+json" />
      <button id="btnClear" title="Clear all">Clear</button>
      <button id="btnDeleteMode" title="Toggle delete mode">üóëÔ∏è Delete: Off</button>
    </div>

    <!-- Field Info panel (hidden by default; draggable) -->
    <section class="panel" id="infoPanel" style="display:none;">
      <h3 id="infoHandle">üìã Field Info</h3>
      <div class="row"><span>Sunrise</span><strong id="pSunrise" class="tag">--:--</strong></div>
      <div class="row"><span>Sunset</span><strong id="pSunset" class="tag">--:--</strong></div>
      <div class="row"><span>Day Length</span><strong id="pDay" class="tag">--h --m</strong></div>
      <div class="row"><span>Total Distance</span><strong id="pDist" class="tag">0 m</strong></div>
      <div class="row"><span>Area</span><strong id="pArea" class="tag">0 m¬≤</strong></div>
      <p class="tag">Tap Ôºã to select a marker type, then tap the map to place. Toggle üóëÔ∏è to remove with a tap.</p>
    </section>

    <!-- Bottom main menu -->
    <nav class="main-menu" id="mainMenu">
      <button id="toggleFieldInfo">Field Info</button>
      <button id="menuWind" class="wind-btn"><span class="wind-arrow" id="windArrow"></span><span id="windText">Wind: --</span></button>
      <button id="menuWaypoints">Waypoints</button>
      <button id="menuTrack">Track</button>
      <button id="menuRadar">Radar</button>
      <button id="toggleBasemap">Basemap</button>
      <button id="menuLocate">Locate Me</button>
    </nav>

    <!-- Shared backdrop for sheets -->
    <div class="backdrop" id="sheetBackdrop"></div>

    <!-- Basemap options sheet -->
    <div class="sheet" id="basemapSheet" aria-hidden="true">
      <div class="grab"></div>
      <h4>Basemap</h4>
      <div class="option"><span>Basic</span><input type="radio" name="basemap" value="basic"></div>
      <div class="option"><span>Satellite</span><input type="radio" name="basemap" value="satellite"></div>
      <div class="option"><span>Topographic</span><input type="radio" name="basemap" value="topo"></div>
    </div>

    <!-- Waypoints manager sheet -->
    <div class="sheet" id="waypointsSheet" aria-hidden="true">
      <div class="grab"></div>
      <h4>Waypoints</h4>
      <div class="content">
        <input id="wpSearch" type="search" placeholder="Search by name or type" />
        <div class="wp-list" id="wpList"></div>
      </div>
    </div>

    <!-- Track recorder sheet -->
    <div class="sheet" id="trackSheet" aria-hidden="true">
      <div class="grab"></div>
      <h4>Track Recorder</h4>
      <div class="content">
        <div class="row"><span>Status</span><strong id="trkStatus" class="tag">Stopped</strong></div>
        <div class="row"><span>Points</span><strong id="trkPts" class="tag">0</strong></div>
        <div class="row"><span>Distance</span><strong id="trkDist" class="tag">0 m</strong></div>
        <div class="row"><span>Duration</span><strong id="trkDur" class="tag">0:00</strong></div>
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="checkbox" id="trkFollow"/> Auto-center while recording</label>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="trkStartStop">Start</button>
          <button class="btn danger" id="trkClear">Clear</button>
          <button class="btn" id="trkExport">Export GPX</button>
        </div>
      </div>
    </div>

    <!-- Radar sheet -->
    <div class="sheet" id="radarSheet" aria-hidden="true">
      <div class="grab"></div>
      <h4>Weather Radar</h4>
      <div class="content">
        <div class="option"><span>Visible</span><label class="switch"><input id="radarToggle" type="checkbox"></label></div>
        <div class="option"><span>Source</span>
          <div>
            <label style="margin-right:10px"><input type="radio" name="radarSrc" value="rainviewer"> RainViewer</label>
            <label><input type="radio" name="radarSrc" value="noaa"> NOAA</label>
          </div>
        </div>
        <div class="option"><span>Opacity</span><input id="radarOpacity" type="range" min="0" max="1" step="0.05" value="0.6" style="width:160px"></div>
        <p class="tag">Tip: RainViewer is global current radar; NOAA is CONUS reflectivity via WMS.</p>
      </div>
    </div>
  </div>

  <script>
    /*******************
     * MAP & BASELAYERS *
     *******************/
    const map = L.map('map').setView([40.4173, -82.9071], 7);
    const basic = L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=VLOZCnjQYBtgpZ3BXBK3', { attribution: '&copy; MapTiler & OpenStreetMap contributors' }).addTo(map);
    const satellite = L.tileLayer('https://api.maptiler.com/tiles/satellite-v2/{z}/{x}/{y}.jpg?key=VLOZCnjQYBtgpZ3BXBK3', { attribution: '&copy; MapTiler' });
    const topo = L.tileLayer('https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=VLOZCnjQYBtgpZ3BXBK3', { attribution: '&copy; MapTiler & OpenStreetMap contributors' });

    const baseByKey = { basic, satellite, topo };
    const STORAGE_BASE = 'ui_basemap_key';
    function setBasemap(key){ Object.values(baseByKey).forEach(l=> map.removeLayer(l)); baseByKey[key].addTo(map); localStorage.setItem(STORAGE_BASE, key); }
    (function restoreBasemap(){ const k = localStorage.getItem(STORAGE_BASE); if(k && baseByKey[k]) setBasemap(k); })();

    /*******************
     * DRAWING LAYERS  *
     *******************/
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({ position:'topleft', edit:{ featureGroup: drawnItems }, draw:{ circle:false } });
    map.addControl(drawControl);

    const STORAGE_DRAW = 'bhh_drawings_v3';
    function saveDraw(){ localStorage.setItem(STORAGE_DRAW, JSON.stringify(drawnItems.toGeoJSON())); updateMeasurements(); }
    function restoreDraw(){ const raw = localStorage.getItem(STORAGE_DRAW); if(raw){ L.geoJSON(JSON.parse(raw), { onEachFeature:(_,layer)=> drawnItems.addLayer(layer) }); updateMeasurements(); } }
    restoreDraw();

    map.on(L.Draw.Event.CREATED, e=>{ drawnItems.addLayer(e.layer); saveDraw(); });
    map.on(L.Draw.Event.EDITED, saveDraw);
    map.on(L.Draw.Event.DELETED, saveDraw);

    /*******************
     * MARKERS (WAYPOINTS)
     *******************/
    const markersLayer = L.featureGroup().addTo(map);
    const STORAGE_MARK = 'bhh_markers_v3';
    const IS_MOBILE = matchMedia('(max-width:640px)').matches;
    const ICON_SZ = IS_MOBILE ? 28 : 32;
    const FONT_SZ = IS_MOBILE ? 16 : 18;

    function makeIcon(bg,emoji){
      return L.divIcon({
        className:'',
        html:`<div style="background:${bg};border:2px solid #333;border-radius:50%;width:${ICON_SZ}px;height:${ICON_SZ}px;display:flex;align-items:center;justify-content:center;font-size:${FONT_SZ}px;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.4);">${emoji}</div>`,
        iconSize:[ICON_SZ,ICON_SZ], iconAnchor:[ICON_SZ/2, ICON_SZ], popupAnchor:[0, -ICON_SZ*0.9]
      });
    }

    const markerTypes = {
      stand:{label:'Tree Stand', emoji:'üéØ', icon:makeIcon('#2563eb','üéØ')},
      feeder:{label:'Feeder', emoji:'üçΩÔ∏è', icon:makeIcon('#16a34a','üçΩÔ∏è')},
      camera:{label:'Trail Camera', emoji:'üì∑', icon:makeIcon('#111827','üì∑')},
      scrape:{label:'Scrape', emoji:'ü¶å', icon:makeIcon('#6d28d9','ü¶å')},
      rub:{label:'Rub', emoji:'ü™µ', icon:makeIcon('#b45309','ü™µ')},
      water:{label:'Water Source', emoji:'üíß', icon:makeIcon('#0891b2','üíß')}
    };

    let activeType=null; let deleteMode=false;
    function setActiveType(type){ activeType=type; document.getElementById('map').classList.toggle('placing', !!type); }

    function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
    function defaultName(type){
      const base = markerTypes[type]?.label || 'Marker';
      let n = 1; markersLayer.eachLayer(m=>{ if(m.options.type===type) n++; });
      return `${base} ${n}`;
    }

    function addMarker(latlng, type, name, id){
      const cfg = markerTypes[type] || {label:'Marker', emoji:'üìç', icon:makeIcon('#555','üìç')};
      const markerId = id || uid();
      const markerName = name || defaultName(type);
      const m = L.marker(latlng, { icon: cfg.icon, draggable:true, type, id: markerId, name: markerName });
      const setPopup = () => m.bindPopup(`<b>${m.options.name}</b><div class="tag">${cfg.label}</div><br><button class="del">Delete</button>`, {autoPan:false});
      setPopup();
      m.on('dragend', saveMarkers);
      m.on('click', () => { if(deleteMode){ markersLayer.removeLayer(m); saveMarkers(); refreshWaypointsUI(); } });
      m.on('popupopen', (e)=>{ const btn = e.popup.getElement().querySelector('button.del'); if(btn) btn.addEventListener('click', ()=> { markersLayer.removeLayer(m); saveMarkers(); refreshWaypointsUI(); }); });
      m.on('popupclose', ()=> saveMarkers());
      m.on('move', ()=> saveMarkers());
      markersLayer.addLayer(m);
      saveMarkers();
      return m;
    }

    function serializeMarkers(){ const list=[]; markersLayer.eachLayer(m=>{ const {lat,lng}=m.getLatLng(); list.push({id:m.options.id, name:m.options.name, type:m.options.type||'marker', lat, lng}); }); return list; }
    function deserializeMarkers(list){ markersLayer.clearLayers(); (list||[]).forEach(m=> addMarker([m.lat,m.lng], m.type, m.name, m.id)); }
    function saveMarkers(){ localStorage.setItem(STORAGE_MARK, JSON.stringify(serializeMarkers())); }
    ;(function restoreMarkers(){ try{ const raw=localStorage.getItem(STORAGE_MARK); if(raw) deserializeMarkers(JSON.parse(raw)); }catch(e){} })();

    map.on('click', e=>{ if(!activeType) return; addMarker(e.latlng, activeType); setActiveType(null); refreshWaypointsUI(); });

    /*******************
     * WAYPOINTS UI     *
     *******************/
    const wpSheet = document.getElementById('waypointsSheet');
    const wpList = document.getElementById('wpList');
    const wpSearch = document.getElementById('wpSearch');

    function getWaypoints(){
      const arr=[]; markersLayer.eachLayer(m=>{ const {lat,lng}=m.getLatLng(); arr.push({ id:m.options.id, name:m.options.name, type:m.options.type, lat, lng, layer:m }); });
      return arr;
    }
    function typeEmoji(t){ return markerTypes[t]?.emoji || 'üìç'; }
    function refreshWaypointsUI(){
      const q = wpSearch.value.toLowerCase();
      const items = getWaypoints().filter(w=> !q || w.name.toLowerCase().includes(q) || (markerTypes[w.type]?.label.toLowerCase().includes(q)));
      wpList.innerHTML = items.map(w=>`
        <div class="wp-item" data-id="${w.id}">
          <div class="wp-emoji">${typeEmoji(w.type)}</div>
          <div class="wp-name"><input type="text" value="${w.name.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"/></div>
          <div class="wp-actions"><button class="btn fly">Fly</button></div>
          <div class="wp-actions"><button class="btn danger del">Delete</button></div>
        </div>`).join('') || '<p class="tag" style="margin-top:8px">No waypoints yet.</p>';
    }

    wpList.addEventListener('click', (e)=>{
      const item = e.target.closest('.wp-item'); if(!item) return; const id=item.dataset.id;
      const wp = getWaypoints().find(w=> w.id===id); if(!wp) return;
      if(e.target.classList.contains('fly')){ map.setView([wp.lat, wp.lng], Math.max(map.getZoom(), 16)); wp.layer.openPopup(); }
      if(e.target.classList.contains('del')){ markersLayer.removeLayer(wp.layer); saveMarkers(); refreshWaypointsUI(); }
    });
    wpList.addEventListener('input', (e)=>{
      const item = e.target.closest('.wp-item'); if(!item) return; const id=item.dataset.id; const wp = getWaypoints().find(w=> w.id===id); if(!wp) return;
      if(e.target.type==='text'){ wp.layer.options.name = e.target.value; // update popup title
        wp.layer.closePopup(); wp.layer.unbindPopup(); const cfg = markerTypes[wp.layer.options.type] || {label:'Marker'}; wp.layer.bindPopup(`<b>${wp.layer.options.name}</b><div class="tag">${cfg.label}</div><br><button class="del">Delete</button>`); saveMarkers(); }
    });
    wpSearch.addEventListener('input', refreshWaypointsUI);

    /*******************
     * TRACK RECORDER   *
     *******************/
    const trackLayer = L.polyline([], { color:'#22d3ee', weight:4, opacity:0.9 }).addTo(map);
    const STORAGE_TRK = 'bhh_track_v1';
    let trackPoints = []; // {lat,lng,t}
    let watchId = null; let startTime = null; let lastPoint = null;

    function loadTrack(){ try{ const raw=localStorage.getItem(STORAGE_TRK); if(raw){ trackPoints = JSON.parse(raw)||[]; trackLayer.setLatLngs(trackPoints.map(p=> [p.lat,p.lng])); } }catch{}; updateTrackStats(); }
    function saveTrack(){ localStorage.setItem(STORAGE_TRK, JSON.stringify(trackPoints)); updateTrackStats(); }

    function appendPoint(lat,lng,t){
      const pt = {lat,lng,t: t||Date.now()};
      if(lastPoint){ const d = map.distance([lastPoint.lat,lastPoint.lng],[lat,lng]); if(d < 3) return; } // 3m threshold
      trackPoints.push(pt); lastPoint = pt; trackLayer.addLatLng([lat,lng]); saveTrack();
    }

    function trackDistance(){ let d=0; for(let i=1;i<trackPoints.length;i++){ d += map.distance([trackPoints[i-1].lat,trackPoints[i-1].lng],[trackPoints[i].lat,trackPoints[i].lng]); } return d; }
    function updateTrackStats(){
      const pts = trackPoints.length; const dist = trackDistance();
      document.getElementById('trkPts').textContent = pts;
      document.getElementById('trkDist').textContent = dist>1000 ? (dist/1000).toFixed(2)+' km' : Math.round(dist)+' m';
      const durMs = startTime ? (Date.now()-startTime) : (trackPoints.length? (trackPoints[trackPoints.length-1].t - trackPoints[0].t):0);
      const mm = Math.floor(durMs/60000), ss=(Math.floor(durMs/1000)%60).toString().padStart(2,'0');
      document.getElementById('trkDur').textContent = `${mm}:${ss}`;
    }

    function startTrack(){
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      if(watchId) return;
      document.getElementById('trkStatus').textContent = 'Recording';
      document.getElementById('trkStartStop').textContent = 'Stop';
      startTime = Date.now();
      watchId = navigator.geolocation.watchPosition(pos=>{
        const {latitude, longitude} = pos.coords; appendPoint(latitude, longitude, Date.now());
        if(document.getElementById('trkFollow').checked){ map.setView([latitude, longitude], Math.max(map.getZoom(), 16)); }
      }, err=>{ console.warn('track error', err); }, { enableHighAccuracy:true, maximumAge:5000 });
    }
    function stopTrack(){ if(!watchId) return; navigator.geolocation.clearWatch(watchId); watchId=null; document.getElementById('trkStatus').textContent = 'Stopped'; document.getElementById('trkStartStop').textContent = 'Start'; updateTrackStats(); }
    function clearTrack(){ stopTrack(); trackPoints=[]; lastPoint=null; trackLayer.setLatLngs([]); saveTrack(); }

    function exportGPX(){
      if(!trackPoints.length){ alert('No track to export'); return; }
      const name = 'BHH Track ' + new Date(trackPoints[0].t).toISOString().slice(0,10);
      const head = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="BuckeyeHunterHub" xmlns="http://www.topografix.com/GPX/1/1">\n<trk><name>${name}</name><trkseg>`;
      const seg = trackPoints.map(p=>`<trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.t).toISOString()}</time></trkpt>`).join('');
      const tail = `</trkseg></trk></gpx>`;
      const blob = new Blob([head+seg+tail], {type:'application/gpx+xml'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name.replace(/\s+/g,'_')+'.gpx'; a.click(); URL.revokeObjectURL(url);
    }

    loadTrack();

    /*******************
     * WIND (live by location) *
     *******************/
    const btnWind = document.getElementById('menuWind');
    const windText = document.getElementById('windText');
    const windArrow = document.getElementById('windArrow');

    function degToCardinal(d){ const dirs = ['N','NE','E','SE','S','SW','W','NW']; return dirs[Math.round(d/45)%8]; }
    function updateWindUI(fromDeg, speed){ const toDeg = (fromDeg + 180) % 360; const from = degToCardinal(fromDeg); const to = degToCardinal(toDeg); windArrow.style.transform = `rotate(${toDeg}deg)`; windText.textContent = `Wind: ${from} ‚Üí ${to}  ${Math.round(speed)} mph`; }

    async function fetchWindAt(lat, lng){ const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=mph`; const r = await fetch(url); if(!r.ok) throw new Error('wind fetch failed'); const j = await r.json(); const cur = j.current || j.current_weather || {}; const speed = cur.wind_speed_10m ?? cur.windspeed ?? 0; const dir = cur.wind_direction_10m ?? cur.winddirection ?? 0; updateWindUI(dir, speed); }
    async function refreshWind(){ try{ if(!navigator.geolocation) throw new Error('no geolocation'); navigator.geolocation.getCurrentPosition(async pos=>{ const {latitude, longitude} = pos.coords; try{ await fetchWindAt(latitude, longitude); } catch(e){ console.warn(e); windText.textContent='Wind: n/a'; } }, err=>{ console.warn(err); windText.textContent='Wind: n/a'; }, {enableHighAccuracy:true, timeout:8000}); }catch(e){ windText.textContent='Wind: n/a'; } }
    btnWind.onclick = refreshWind; refreshWind(); setInterval(refreshWind, 15*60*1000);

    /*******************
     * OHIO PUBLIC HUNTING (Local file first, then ODNR)
     *******************/
    const ohioPublic = L.geoJSON(null, {
      style:{ color:'#8b5cf6', weight:2, fillOpacity:0.15 },
      onEachFeature:(feat, layer)=>{
        const p = feat && feat.properties ? feat.properties : {};
        const preferred = ['NAME','AREA_NAME','UNIT_NAME','PARK_NAME','SITE_NAME','COUNTY','ACRES','AREA_ACRES','OWNER','AGENCY','STATUS','TYPE','ACCESS','SEASON'];
        const headerKey = preferred.find(k=> k in p) || Object.keys(p)[0];
        const name = headerKey ? String(p[headerKey]) : 'Public Hunting Area';
        const keysOrdered = [...new Set([...preferred.filter(k=>k in p), ...Object.keys(p)])].slice(0,12);
        const rows = keysOrdered.map(k=>`<div><span style=\"color:#a3b7a6\">${k}:</span> ${String(p[k])}</div>`).join('');
        layer.bindPopup(`<b>${name}</b><div style=\"margin-top:6px\">${rows}</div>`);
        layer.on('mouseover', ()=> layer.setStyle({weight:3}));
        layer.on('mouseout',  ()=> layer.setStyle({weight:2}));
      }
    });

    async function loadOhioPublic(){
      try{ const localResp = await fetch('ohio_public_hunting.geojson', {cache:'reload'}); if(localResp.ok){ const localJson = await localResp.json(); ohioPublic.addData(localJson); console.info('Loaded local ohio_public_hunting.geojson'); return; } }catch(e){ console.info('Local ohio_public_hunting.geojson not found'); }
      try{ const odnrResp = await fetch('https://gis2.ohiodnr.gov/ArcGIS/rest/services/OIT_Services/DNR_Fed_Lands_Nav_Base/MapServer/2/query?where=1%3D1&outFields=*&outSR=4326&f=geojson'); const odnrJson = await odnrResp.json(); ohioPublic.addData(odnrJson); console.info('Loaded ODNR fallback layer'); }catch(err){ console.warn('ODNR layer fetch failed', err); }
    }
    loadOhioPublic();

    /*******************
     * RADAR LAYERS     *
     *******************/
    const radarRain = L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast/256/{z}/{x}/{y}/2/1_1.png', { opacity: 0.6, attribution: 'RainViewer' });
    const radarNoaa = L.tileLayer.wms('https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows?', {
      layers: 'conus_bref_qcd', format: 'image/png', transparent: true, opacity: 0.6, attribution: 'NOAA/NWS' });

    function setRadarSource(src){
      const vis = document.getElementById('radarToggle').checked;
      // remove both
      map.removeLayer(radarRain); map.removeLayer(radarNoaa);
      if(!vis) return;
      if(src==='noaa') { radarNoaa.setOpacity(parseFloat(radarOpacity.value)); radarNoaa.addTo(map); }
      else { radarRain.setOpacity(parseFloat(radarOpacity.value)); radarRain.addTo(map); }
      localStorage.setItem('radar_src', src);
    }

    function setRadarVisibility(v){ document.getElementById('radarToggle').checked = v; localStorage.setItem('radar_vis', v? '1':'0'); setRadarSource(localStorage.getItem('radar_src')||'rainviewer'); }
    function setRadarOpacity(val){ const v=parseFloat(val); radarRain.setOpacity(v); radarNoaa.setOpacity(v); localStorage.setItem('radar_opacity', v.toString()); }

    // (optional) also add to layers control
    const overlaysForControl = { 'Ohio Public Hunting (ODNR)': ohioPublic, 'Hunt Markers': markersLayer, 'My Drawings': drawnItems, 'My Track': trackLayer };
    L.control.layers({ 'Basic':basic, 'Satellite':satellite, 'Topographic':topo }, overlaysForControl, { position:'bottomleft' }).addTo(map);

    /*******************
     * TOOLBAR ACTIONS  *
     *******************/
    const btnExport = document.getElementById('btnExport');
    const btnClear  = document.getElementById('btnClear');
    const btnDelete = document.getElementById('btnDeleteMode');
    const fileInput = document.getElementById('fileImport');

    btnExport.onclick = () => {
      const data = { drawings: drawnItems.toGeoJSON(), markers: serializeMarkers(), track: trackPoints };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='buckeyehunterhub-export.json'; a.click(); URL.revokeObjectURL(url);
    };
    btnClear.onclick = () => { drawnItems.clearLayers(); saveDraw(); markersLayer.clearLayers(); saveMarkers(); clearTrack(); updateMeasurements(); };
    btnDelete.onclick = () => { deleteMode = !deleteMode; btnDelete.textContent = `üóëÔ∏è Delete: ${deleteMode? 'On':'Off'}`; };
    fileInput.onchange = (ev) => {
      const f = ev.target.files[0]; if(!f) return; const r=new FileReader();
      r.onload = () => { try{ const obj = JSON.parse(r.result);
        if(obj.type==='FeatureCollection' || obj.type==='Feature'){ L.geoJSON(obj, {onEachFeature:(_,l)=>drawnItems.addLayer(l)}); saveDraw(); }
        else { if(obj.drawings) L.geoJSON(obj.drawings, {onEachFeature:(_,l)=>drawnItems.addLayer(l)}); if(obj.markers) deserializeMarkers(obj.markers); if(obj.track) { trackPoints = obj.track; trackLayer.setLatLngs(trackPoints.map(p=>[p.lat,p.lng])); saveTrack(); } }
      } catch{ alert('Invalid JSON/GeoJSON file'); } finally { ev.target.value=''; } };
      r.readAsText(f);
    };

    /*******************
     * SUN INFO         *
     *******************/
    function updateSun(){ const c = map.getCenter(); const now = new Date(); const t = SunCalc.getTimes(now, c.lat, c.lng); const fmt = d => d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--'; document.getElementById('pSunrise').textContent = fmt(t.sunrise); document.getElementById('pSunset').textContent  = fmt(t.sunset); const mins = Math.max(0, (t.sunset - t.sunrise)/60000|0); document.getElementById('pDay').textContent = `${Math.floor(mins/60)}h ${mins%60}m`; }
    updateSun(); map.on('moveend', updateSun);

    /*******************
     * MEASUREMENTS     *
     *******************/
    function updateMeasurements(){
      let dist=0; drawnItems.eachLayer(l=>{ if(l instanceof L.Polyline && !(l instanceof L.Polygon)){ const latlngs = l.getLatLngs(); for(let i=1;i<latlngs.length;i++){ dist += map.distance(latlngs[i-1], latlngs[i]); } } });
      document.getElementById('pDist').textContent = dist>1000 ? (dist/1000).toFixed(2)+' km' : Math.round(dist)+' m';
      let area=0; drawnItems.eachLayer(l=>{ if(l instanceof L.Polygon){ const rings=l.getLatLngs()[0]||[]; for(let i=0;i<rings.length;i++){ const a=rings[i], b=rings[(i+1)%rings.length]; area += (a.lng*b.lat - b.lng*a.lat); } area=Math.abs(area/2)*12365; } });
      const areaEl=document.getElementById('pArea'); if(area>1e6) areaEl.textContent=(area/1e6).toFixed(2)+' km¬≤'; else if(area>1e4) areaEl.textContent=(area/1e4).toFixed(1)+' ha'; else areaEl.textContent=Math.round(area)+' m¬≤';
    }
    map.on(L.Draw.Event.CREATED, updateMeasurements); map.on(L.Draw.Event.EDITED, updateMeasurements); map.on(L.Draw.Event.DELETED, updateMeasurements);

    /*******************
     * UI: FAB & MENU   *
     *******************/
    const fab = document.getElementById('fabMain');
    const menu = document.getElementById('markerMenu');
    fab.onclick = ()=> menu.classList.toggle('show');
    menu.querySelectorAll('button[data-type]').forEach(btn=> btn.addEventListener('click', ()=>{ setActiveType(btn.dataset.type); menu.classList.remove('show'); }));

    const btnFieldInfo = document.getElementById('toggleFieldInfo');
    const infoPanel = document.getElementById('infoPanel');
    const btnBasemap = document.getElementById('toggleBasemap');
    const btnLocate  = document.getElementById('menuLocate');
    const btnWaypoints = document.getElementById('menuWaypoints');
    const btnTrack = document.getElementById('menuTrack');
    const btnRadar = document.getElementById('menuRadar');

    const sheetBg = document.getElementById('sheetBackdrop');
    const sheetMap = { basemap: document.getElementById('basemapSheet'), waypoints: document.getElementById('waypointsSheet'), track: document.getElementById('trackSheet'), radar: document.getElementById('radarSheet') };
    function openSheet(which){ Object.values(sheetMap).forEach(s=> s.classList.remove('show')); sheetBg.classList.add('show'); sheetMap[which].classList.add('show'); if(which==='waypoints') refreshWaypointsUI(); }
    function closeSheets(){ sheetBg.classList.remove('show'); Object.values(sheetMap).forEach(s=> s.classList.remove('show')); }
    sheetBg.onclick = closeSheets;

    // Basemap sheet wiring
    const radios = Array.from(document.querySelectorAll('input[name="basemap"]'));
    function syncBaseRadio(){ const k = localStorage.getItem(STORAGE_BASE) || 'basic'; const r = radios.find(r=>r.value===k); if(r) r.checked = true; }
    btnBasemap.onclick = ()=>{ syncBaseRadio(); openSheet('basemap'); };
    radios.forEach(r=> r.addEventListener('change', ()=>{ setBasemap(r.value); closeSheets(); }));

    // Waypoints
    btnWaypoints.onclick = ()=> openSheet('waypoints');

    // Track
    btnTrack.onclick = ()=> openSheet('track');
    document.getElementById('trkStartStop').onclick = ()=>{ if(watchId) stopTrack(); else startTrack(); };
    document.getElementById('trkClear').onclick = clearTrack;
    document.getElementById('trkExport').onclick = exportGPX;

    // Radar
    const radarToggle = document.getElementById('radarToggle');
    const radarOpacity = document.getElementById('radarOpacity');
    const radarSrcRadios = Array.from(document.querySelectorAll('input[name="radarSrc"]'));
    function restoreRadar(){ const vis = localStorage.getItem('radar_vis')==='1'; const src = localStorage.getItem('radar_src')||'rainviewer'; const op = parseFloat(localStorage.getItem('radar_opacity')||'0.6'); radarToggle.checked = vis; radarOpacity.value = op; const r = radarSrcRadios.find(r=>r.value===src); if(r) r.checked=true; setRadarOpacity(op); setRadarSource(src); }
    btnRadar.onclick = ()=>{ restoreRadar(); openSheet('radar'); };
    radarToggle.onchange = ()=> setRadarVisibility(radarToggle.checked);
    radarOpacity.oninput = ()=> setRadarOpacity(radarOpacity.value);
    radarSrcRadios.forEach(r=> r.addEventListener('change', ()=> setRadarSource(r.value)));

    // Field Info toggle & position persistence
    const STORAGE_INFO_POS = 'ui_info_pos';
    const STORAGE_INFO_VIS = 'ui_info_visible';
    function setInfoVisible(v){ infoPanel.style.display = v? 'block':'none'; localStorage.setItem(STORAGE_INFO_VIS, v? '1':'0'); if(v){ updateSun(); updateMeasurements(); } }
    function getInfoVisible(){ return localStorage.getItem(STORAGE_INFO_VIS) === '1'; }
    btnFieldInfo.onclick = ()=> setInfoVisible(infoPanel.style.display==='none' || infoPanel.style.display==='');

    setInfoVisible(getInfoVisible());

    // Locate
    btnLocate.onclick = ()=>{ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } navigator.geolocation.getCurrentPosition(pos=>{ const latlng=[pos.coords.latitude, pos.coords.longitude]; map.setView(latlng, 15); }, err=> alert('Location error: '+err.message), { enableHighAccuracy:true, timeout:8000 }); };

    // Draggable Field Info
    function makeDraggable(el, handle, storageKey){
      let sx=0, sy=0, sl=0, st=0, dragging=false;
      const start=(x,y)=>{ dragging=true; sx=x; sy=y; const r=el.getBoundingClientRect(); sl=r.left; st=r.top; document.addEventListener('mousemove',move); document.addEventListener('mouseup',up); document.addEventListener('touchmove',tmove,{passive:false}); document.addEventListener('touchend',up); };
      const down=(e)=>{ const p=point(e); start(p.x,p.y); e.preventDefault(); };
      const tdown=(e)=>{ const p=point(e); start(p.x,p.y); };
      const move=(e)=>{ if(!dragging) return; const p=point(e); apply(sl+p.x-sx, st+p.y-sy); e.preventDefault(); };
      const tmove=(e)=>{ if(!dragging) return; const p=point(e); apply(sl+p.x-sx, st+p.y-sy); e.preventDefault(); };
      const up=()=>{ dragging=false; document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); document.removeEventListener('touchmove',tmove); document.removeEventListener('touchend',up); savePos(); };
      function point(e){ if(e.touches && e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY}; return {x:e.clientX,y:e.clientY}; }
      function apply(l,t){ const vw=innerWidth, vh=innerHeight; const w=el.offsetWidth, h=el.offsetHeight; l=Math.max(4,Math.min(vw-w-4,l)); t=Math.max(60,Math.min(vh-h-4,t)); el.style.left=l+'px'; el.style.top=t+'px'; }
      function savePos(){ const r=el.getBoundingClientRect(); localStorage.setItem(storageKey, JSON.stringify({left:r.left, top:r.top})); }
      try{ const s=JSON.parse(localStorage.getItem(storageKey)||'null'); if(s){ el.style.left=s.left+'px'; el.style.top=s.top+'px'; } }catch{}
      handle.addEventListener('mousedown',down); handle.addEventListener('touchstart',tdown,{passive:false});
    }
    makeDraggable(infoPanel, document.getElementById('infoHandle'), STORAGE_INFO_POS);
  </script>
</body>
</html>
