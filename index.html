<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Buckeye Hunter Hub ‚Äì Hunt Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- SunCalc -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    html, body { height:100%; margin:0; background:#fff; }
    #map { width:100%; height:100vh; }
    #map.placing { cursor: crosshair; }

    /* Toolbar bottom-right */
    .toolbar {
      position: fixed;
      bottom: calc(12px + var(--safe-bottom));
      right: 12px;
      z-index: 1000;
      background: #fff; border-radius: 10px; padding: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
    }
    .toolbar button, .toolbar label {
      margin: 0; padding: 6px 10px; cursor: pointer;
      border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;
    }
    .toolbar input[type="file"] { display: none; }

    /* Panel */
    .panel {
      position: fixed;
      top: 12px; right: 12px; z-index: 900;
      background: #fff; border-radius: 10px; padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
      max-width: 260px;
      font: 14px/1.4 system-ui;
    }
    .panel .drag-handle {
      font-weight: 600; margin-bottom: 6px; display:flex; align-items:center; gap:8px;
      cursor: move; user-select:none;
    }
    .grip { width: 24px; height: 4px; border-radius: 4px; background:#ccc; }

    /* Marker FAB + menu */
    .fab-marker {
      position:fixed; right:16px; bottom:100px; z-index:1200;
      width:56px; height:56px; border-radius:50%;
      background:#16a34a; color:#fff; font-size:32px; line-height:1;
      border:none; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.3);
    }
    .marker-menu {
      position:fixed; right:16px; bottom:160px; z-index:1200;
      background:#fff; border:1px solid #ddd; border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      display:none; flex-direction:column; gap:6px; padding:8px;
    }
    .marker-menu.show { display:flex; }
    .marker-menu button {
      padding:6px 10px; border:1px solid #ddd; border-radius:8px;
      background:#f9f9f9; text-align:left; cursor:pointer;
      font: 14px system-ui;
    }

    /* Locate button */
    .locate-btn {
      position: fixed; right: 12px; bottom: 220px;
      z-index: 1200;
      background:#fff; border:1px solid #ddd; border-radius: 999px;
      padding: 8px 12px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      font: 14px system-ui; cursor: pointer;
    }
    .locate-btn:active { transform: scale(0.98); }

    .draggable { position: fixed; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Marker FAB & menu -->
  <button id="fabMarker" class="fab-marker">Ôºã</button>
  <div id="markerMenu" class="marker-menu">
    <button data-type="stand">üéØ Stand</button>
    <button data-type="feeder">üçΩÔ∏è Feeder</button>
    <button data-type="camera">üì∑ Camera</button>
    <button data-type="rub">ü™µ Rub</button>
    <button data-type="scrape">ü¶å Scrape</button>
    <button id="btnClearMarkers">Clear All</button>
  </div>

  <!-- Toolbar -->
  <div class="toolbar draggable" id="mainToolbar">
    <button class="drag-handle" title="Drag me">‚ÜîÔ∏è</button>
    <button id="btnExport">Export</button>
    <button id="btnClear">Clear</button>
    <label for="fileImport">Import</label>
    <input type="file" id="fileImport" accept=".geojson,.json,application/json"/>
    <button id="btnFull">Fullscreen</button>
  </div>

  <!-- Legal Light panel -->
  <div class="panel draggable" id="panelLegal">
    <div class="drag-handle"><div class="grip"></div>Legal Light</div>
    <div id="sunrise"></div>
    <div id="sunset"></div>
    <div id="civilDawn"></div>
    <div id="civilDusk"></div>
    <div id="dayLength"></div>
  </div>

  <!-- Locate button -->
  <button class="locate-btn draggable drag-handle" id="btnLocate" type="button">üìç Locate Me</button>

  <script>
    // --- Map ---
    const map = L.map('map').setView([40.4173, -82.9071], 6);
    const basic = L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=YOUR_MAPTILER_KEY',{attribution:'&copy; MapTiler & OSM'}).addTo(map);
    const satellite = L.tileLayer('https://api.maptiler.com/tiles/satellite-v2/{z}/{x}/{y}.jpg?key=YOUR_MAPTILER_KEY');
    const topo = L.tileLayer('https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=YOUR_MAPTILER_KEY');

    // --- Drawing ---
    const drawnItems = new L.FeatureGroup().addTo(map);
    map.addControl(new L.Control.Draw({ position:'topleft', edit:{ featureGroup: drawnItems }, draw:{circle:false} }));
    const STORAGE_DRAW="bhh_drawings";
    function saveDraw(){ localStorage.setItem(STORAGE_DRAW, JSON.stringify(drawnItems.toGeoJSON())); }
    function restoreDraw(){ const raw=localStorage.getItem(STORAGE_DRAW); if(raw) L.geoJSON(JSON.parse(raw),{onEachFeature:(_,l)=>drawnItems.addLayer(l)});}
    restoreDraw();
    map.on(L.Draw.Event.CREATED, e=>{ drawnItems.addLayer(e.layer); saveDraw(); });
    map.on(L.Draw.Event.EDITED, saveDraw); map.on(L.Draw.Event.DELETED, saveDraw);

    // --- Markers ---
    const markersLayer=L.featureGroup().addTo(map); const STORAGE_MARK="bhh_markers";
    const IS_MOBILE=window.matchMedia('(max-width:640px)').matches;
    const ICON_SZ=IS_MOBILE?28:32, FONT_SZ=IS_MOBILE?16:18;
    function makeIcon(bg,emoji){ return L.divIcon({className:'',html:`<div style=\"background:${bg};border:2px solid #333;border-radius:50%;width:${ICON_SZ}px;height:${ICON_SZ}px;display:flex;align-items:center;justify-content:center;font-size:${FONT_SZ}px;color:#fff;\">${emoji}</div>`,iconSize:[ICON_SZ,ICON_SZ],iconAnchor:[ICON_SZ/2,ICON_SZ],popupAnchor:[0,-ICON_SZ*0.9]}); }
    const markerTypes={ stand:{label:'Stand',icon:makeIcon('#2563eb','üéØ')}, feeder:{label:'Feeder',icon:makeIcon('#16a34a','üçΩÔ∏è')}, camera:{label:'Camera',icon:makeIcon('#111827','üì∑')}, rub:{label:'Rub',icon:makeIcon('#b45309','ü™µ')}, scrape:{label:'Scrape',icon:makeIcon('#6d28d9','ü¶å')} };

    let activeType=null;
    function setActiveType(t){ activeType=t; document.getElementById('map').classList.toggle('placing',!!t); }
    map.on('click', e=>{ if(!activeType) return; const cfg=markerTypes[activeType]; L.marker(e.latlng,{icon:cfg.icon,type:activeType}).addTo(markersLayer).bindPopup(`<b>${cfg.label}</b>`); saveMarkers(); });

    function serializeMarkers(){ const list=[]; markersLayer.eachLayer(m=>{const {lat,lng}=m.getLatLng(); list.push({type:m.options.type,lat,lng});}); return list;}
    function deserializeMarkers(list){ markersLayer.clearLayers(); (list||[]).forEach(m=>{const cfg=markerTypes[m.type]||{icon:makeIcon('#555','üìç'),label:'Marker'}; L.marker([m.lat,m.lng],{icon:cfg.icon,type:m.type}).addTo(markersLayer).bindPopup(`<b>${cfg.label}</b>`); });}
    function saveMarkers(){ localStorage.setItem(STORAGE_MARK, JSON.stringify(serializeMarkers())); }
    (function(){ try{const raw=localStorage.getItem(STORAGE_MARK); if(raw) deserializeMarkers(JSON.parse(raw));}catch{}})();

    // FAB menu logic
    const fab=document.getElementById('fabMarker'), menu=document.getElementById('markerMenu');
    fab.onclick=()=>menu.classList.toggle('show');
    menu.querySelectorAll('button[data-type]').forEach(btn=>{
      btn.addEventListener('click',()=>{ setActiveType(btn.dataset.type); menu.classList.remove('show'); });
    });
    document.getElementById('btnClearMarkers').onclick=()=>{ markersLayer.clearLayers(); saveMarkers(); };

    // --- Toolbar buttons ---
    document.getElementById('btnExport').onclick=()=>{
      const data={drawings:drawnItems.toGeoJSON(), markers:serializeMarkers()};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='buckeyehunterhub-export.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('btnClear').onclick=()=>{ drawnItems.clearLayers(); saveDraw(); markersLayer.clearLayers(); saveMarkers(); };
    document.getElementById('fileImport').onchange=ev=>{ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{const obj=JSON.parse(r.result); if(obj.drawings) L.geoJSON(obj.drawings,{onEachFeature:(_,l)=>drawnItems.addLayer(l)}); if(obj.markers) deserializeMarkers(obj.markers); saveDraw(); saveMarkers(); }catch{alert('Invalid JSON');}}; r.readAsText(f); ev.target.value=''; };
    document.getElementById('btnFull').onclick=()=>{const el=map.getContainer(); if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); };

    // --- Locate Me ---
    const btnLocate=document.getElementById('btnLocate'); let youHere=null, youAcc=null;
    btnLocate.onclick=()=>{ if(!navigator.geolocation){alert('No geolocation'); return;} btnLocate.textContent='Locating‚Ä¶'; navigator.geolocation.getCurrentPosition(pos=>{btnLocate.textContent='üìç Locate Me';const {latitude,longitude,accuracy}=pos.coords; const latlng=[latitude,longitude]; if(youHere) map.removeLayer(youHere); if(youAcc) map.removeLayer(youAcc); youAcc=L.circle(latlng,{radius:Math.min(accuracy||50,200),color:'#2563eb',fillColor:'#3b82f6',fillOpacity:0.15,weight:2}).addTo(map); youHere=L.circleMarker(latlng,{radius:8,color:'#2563eb',weight:3,fillColor:'#3b82f6',fillOpacity:0.9}).addTo(map).bindPopup('You are here').openPopup(); map.setView(latlng,15); },err=>{btnLocate.textContent='üìç Locate Me'; alert('Location error: '+err.message);},{enableHighAccuracy:true,timeout:8000}); };

    // --- Layers control ---
    L.control.layers(
      {Basic:basic, Satellite:satellite, Topo:topo},
      {Drawings:drawnItems, Markers:markersLayer},
      {position:'bottomleft'}
    ).addTo(map);

    // --- Legal Light ---
    function updateSun(){ const c=map.getCenter(), now=new Date(), t=SunCalc.getTimes(now,c.lat,c.lng); const fmt=d=>d?d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'‚Äî'; document.getElementById('sunrise').textContent=\"Sunrise: \"+fmt(t.sunrise); document.getElementById('sunset').textContent=\"Sunset: \"+fmt(t.sunset); document.getElementById('civilDawn').textContent=\"Civil dawn: \"+fmt(t.dawn); document.getElementById('civilDusk').textContent=\"Civil dusk: \"+fmt(t.dusk); const mins=(t.sunset-t.sunrise)/60000; document.getElementById('dayLength').textContent=\"Day length: \"+Math.floor(mins/60)+\"h \"+(mins%60|0)+\"m\"; } updateSun(); map.on('moveend',updateSun);
  </script>
</body>
</html>
